import pyautogui
import pydirectinput
import time
import random
import mss
import numpy as np
from PIL import Image
import gc

def ana_fonksiyon():
    """
    Programın ana fonksiyonu
    """
    # Maksimum atma süresi 1.9 saniye
    # Her zaman atılacak temel süre
    atmaTemelSüresi = 1.0
    # Temel süreye eklenecek maksimum rastgele süre
    atmaRastgele = 0.4

    # İpucu hattını ne kadar süreyle bırakacağı
    ipucuHattiBeklemeSüresi = 1.5

    # Animasyon bekleme sürelerine rastgelelik ekleniyor
    animasyonBeklemeSüresi = 0.1 + (0.1 * random.random())

    # Rastgele olarak sağa veya sola hareket eder, AFK'yi önlemek için
    hareketYönü = ["a", "d"]

    # Serbest kamera tuşu
    serbestKameraTuşu = "alt"

    # Başlığı "New World" olan tüm pencereleri bulur
    newWorldPencereleri = pyautogui.getWindowsWithTitle("New World")

    # Genellikle gerçek oyun penceresi olan "New World" başlığını bulun
    for pencere in newWorldPencereleri:
        if pencere.title == "New World":
            newWorldPenceresi = pencere
            break

    # O pencereyi seçin
    newWorldPenceresi.activate()

    # Fareyi oyun penceresinin ortasına taşıyın
    merkezW = newWorldPenceresi.left + (newWorldPenceresi.width / 2)
    merkezH = newWorldPenceresi.top + (newWorldPenceresi.height / 2)
    pyautogui.moveTo(merkezW, merkezH)

    # Tıklama işlemi
    time.sleep(animasyonBeklemeSüresi)
    pyautogui.click()
    time.sleep(animasyonBeklemeSüresi)

    # "New World" penceresinin orta 1/3'ünü seçin
    mssBölgesi = {"mon": 1, "top": newWorldPenceresi.top, "left": newWorldPenceresi.left + round(newWorldPenceresi.width / 3), "width": round(newWorldPenceresi.width / 3), "height": newWorldPenceresi.height}

    # Ekran görüntüsü alma nesnesini başlat
    sct = mss.mss()

    # İlk atışın kısa olma sorununu çözmesi için bekleyin
    time.sleep(animasyonBeklemeSüresi * 3)

    while True:
        # Ekran görüntüsü al
        sctResim = Image.fromarray(np.array(sct.grab(mssBölgesi)))
        # Atma süresini hesapla
        atmaSüresi = atmaTemelSüresi + (atmaRastgele * random.random())

        # "Serbest Bakış" tuşunu basılı tut
        print("Serbest Bakış Tuşuna Basılı Tutuluyor")
        pydirectinput.keyDown(serbestKameraTuşu)

        # Atma işlemi
        print("İpucu Atılıyor")
        pyautogui.mouseDown()
        time.sleep(atmaSüresi)
        pyautogui.mouseUp()

        # Balık ikonunu ara, zorla bellek temizliği yap
        while pyautogui.locate("imgs/fishIcon.png", sctResim, grayscale=True, confidence=0.6) is None:
            gc.collect()
            # Ekran görüntüsü alma
            sctResim = Image.fromarray(np.array(sct.grab(mssBölgesi)))

        # Balık tutma
        print("Balık Tutuldu")
        pyautogui.click()
        time.sleep(animasyonBeklemeSüresi)

        # "HOLD Atma" metni ekranda görünene kadar çekme işlemine devam et
        while pyautogui.locate("imgs/holdCast.png", sctResim, grayscale=True, confidence=0.55) is None:
            print("Çekiliyor...")
            pyautogui.mouseDown()

            # İkon turuncu alandaysa, ipucu hattını bırak
            if pyautogui.locate("imgs/fishReelingOrange.png", sctResim, grayscale=True, confidence=0.75) is not None:
                print("İpucu Hattı Bırakılıyor...")
                pyautogui.mouseUp()
                time.sleep(ipucuHattiBeklemeSüresi)

            # Belleği temizlemek için zorlama yapar
            gc.collect()
            # Ekran görüntüsü alma
            sctResim = Image.fromarray(np.array(sct.grab(mssBölgesi)))

            # Aşağı çekme süresi
            time.sleep(animasyonBeklemeSüresi)

        pyautogui.mouseUp()
        time.sleep(animasyonBeklemeSüresi)
        print("Balık Yakalandı")

        # AFK süresini önlemek için yüzde 20 olasılıkla hareket et
        if random.randint(1, 5) == 5:
            tuş = hareketYönü[random.randint(0, 1)]
            pyautogui.keyDown(tuş)
            time.sleep(0.1)
            pyautogui.keyUp(tuş)

        time.sleep(animasyonBeklemeSüresi)

        # "Serbest Bakış" tuşunu bırak
        print("Serbest Bakış Tuşu Bırakıldı")
        pydirectinput.keyUp(serbestKameraTuşu)

# Ana fonksiyonu çalıştır
if __name__ == '__main__':
    ana_fonksiyon()
